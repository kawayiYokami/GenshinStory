# 文档 2: 搜索引擎构建流程

本文档详细说明了为静态前端站点构建搜索引擎数据的过程。该过程的核心是将后端缓存中的搜索索引转换为前端可以高效查询的、分片式的 JSON 文件。主要涉及的脚本是 `scripts/gi_generate_markdown.py` 和 `scripts/hsr_generate_markdown.py`。

## 核心目标

搜索引擎的构建旨在实现：

1.  **前端离线搜索**：让用户能够在浏览器端进行快速的全文搜索，而无需向后端服务器发送实时查询请求。
2.  **性能优化**：避免前端一次性加载庞大的完整索引，通过将索引分片（chunking）来减少初始加载体积和内存占用。
3.  **解耦**：将数据生成过程与前端应用完全分离。前端只负责消费生成好的静态 JSON 文件。

## 构建流程 (`gi_generate_markdown.py`)

`gi_generate_markdown.py` 脚本在生成 Markdown 文件的同时，也负责为《原神》数据构建前端搜索引擎。

### 1. 从缓存加载

-   脚本首先通过 `GameDataAPI` 从前一步生成的 `gi_data.cache.gz` 文件加载数据。
-   这次加载会将在缓存构建阶段创建的、完整的内存搜索索引 (`_search_index`) 一并载入到 `api.loader` 对象中。这个索引是一个以“词条”为键，以包含该词条的文档信息列表为值的倒排索引。

### 2. 导出分片式搜索索引 (`export_search_index_chunked`)

-   这是构建前端搜索引擎的核心函数。
-   **分片逻辑**：
    -   函数遍历内存中完整的 `_search_index`。
    -   对于索引中的每一个词条（keyword），它会取该词条的**第一个字符**作为分片键（chunk key）。
    -   所有以相同字符开头的词条及其关联的文档 ID 列表，会被归类到同一个分片中。
-   **数据结构**：
    -   分片后的数据结构是一个嵌套字典，例如：
        ```json
        // '旅.json'
        {
          "旅行者": [1001, 2005, 3010],
          "旅行": [1001, 5021]
        }
        ```
    -   注意：为了极致的性能，最终的 JSON 文件中只保留了文档的 **ID 列表**，而没有保留完整的元数据。文档的详细信息（如名称、路径）存储在另一个主索引文件 (`index_gi.json`) 中。
-   **文件写入**：
    -   每一个分片都会被写入一个单独的 JSON 文件。
    -   文件名直接使用分片的键（即词条的第一个字符）命名，如 `旅.json`, `a.json`, `1.json`。
    -   所有这些分片文件都保存在 `web/docs-site/public/search/` 目录下。
    -   为了减小文件体积，这些 JSON 文件在保存时会移除所有不必要的空格 (`separators=(',', ':')`)。

## HSR 搜索引擎构建 (`hsr_generate_markdown.py`)

`hsr_generate_markdown.py` 脚本遵循了与 GI 版本完全相同的逻辑来为《崩坏：星穹铁道》构建搜索引擎：

1.  **从缓存加载**：脚本从 `hsr_data.cache.gz` 加载 `CacheService` 实例，该实例包含了在缓存构建阶段生成的 HSR 搜索索引。
2.  **分片与导出**：调用 `export_search_index_chunked` 函数，执行与 GI 版本相同的分片逻辑（按词条首字母分片）。
3.  **文件输出**：将生成的分片 JSON 文件保存到 `web/docs-site/public/search_hsr/` 目录下。

## 前端如何使用

1.  **用户输入**：当用户在搜索框输入查询词，例如 "旅行者"。
2.  **请求分片**：前端逻辑会取查询词的第一个字符 "旅"，然后异步请求对应的分片文件 `/search/旅.json`。
3.  **本地查询**：获取到 `旅.json` 的内容后，前端在内存中查找键为 "旅行者" 的条目，得到一个文档 ID 列表 `[1001, 2005, 3010]`。
4.  **匹配主索引**：前端使用这些 ID，在预先加载好的主索引文件 (`index_gi.json`) 中查找对应的文档元数据（名称、URL路径等）。
5.  **展示结果**：将匹配到的文档信息渲染成搜索结果列表展示给用户。

## 结论

通过将庞大的搜索索引按首字母切分成数千个小文件，项目实现了一个高性能、低延迟的纯静态前端搜索引擎。这种策略有效地平衡了搜索的全面性与前端应用的性能要求，是静态知识库或文档网站的理想选择。